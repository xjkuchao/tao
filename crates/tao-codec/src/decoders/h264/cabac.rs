//! CABAC (Context-Adaptive Binary Arithmetic Coding) 引擎.
//!
//! 实现 H.264 CABAC 二进制算术解码的核心逻辑.

/// CABAC 上下文模型
#[derive(Clone, Copy)]
pub struct CabacCtx {
    /// 概率状态索引 (0-63)
    pub state: u8,
    /// 最大概率符号 (0 或 1)
    pub mps: u8,
}

/// CABAC 解码器
pub struct CabacDecoder<'a> {
    data: &'a [u8],
    pos: usize,
    range: u32,
    offset: u32,
    bits_needed: i32,
}

impl<'a> CabacDecoder<'a> {
    /// 从字节切片初始化 CABAC 解码器
    pub fn new(data: &'a [u8]) -> Self {
        if data.len() < 2 {
            return Self {
                data,
                pos: data.len(),
                range: 510,
                offset: 0,
                bits_needed: 0,
            };
        }
        let offset = ((data[0] as u32) << 9) | ((data[1] as u32) << 1);
        Self {
            data,
            pos: 2,
            range: 510,
            offset,
            bits_needed: -7,
        }
    }

    /// 带上下文模型的算术解码 (regular mode)
    pub fn decode_decision(&mut self, ctx: &mut CabacCtx) -> u32 {
        let q_idx = ((self.range >> 6) & 3) as usize;
        let s = ctx.state as usize;
        let range_lps = RANGE_TAB_LPS[s][q_idx] as u32;
        let range_mps = self.range - range_lps;

        if self.offset < range_mps {
            self.range = range_mps;
            ctx.state = TRANS_IDX_MPS[s];
            self.renormalize();
            ctx.mps as u32
        } else {
            self.offset -= range_mps;
            self.range = range_lps;
            let symbol = 1 - ctx.mps as u32;
            if ctx.state == 0 {
                ctx.mps = 1 - ctx.mps;
            }
            ctx.state = TRANS_IDX_LPS[s];
            self.renormalize();
            symbol
        }
    }

    /// 旁路模式解码 (等概率)
    pub fn decode_bypass(&mut self) -> u32 {
        self.offset <<= 1;
        self.bits_needed += 1;
        if self.bits_needed >= 0 {
            self.load_byte();
        }
        if self.offset >= self.range {
            self.offset -= self.range;
            1
        } else {
            0
        }
    }

    /// 终止模式解码 (end_of_slice_flag)
    pub fn decode_terminate(&mut self) -> u32 {
        self.range -= 2;
        if self.offset >= self.range {
            1
        } else {
            self.renormalize();
            0
        }
    }

    /// 重归一化
    fn renormalize(&mut self) {
        while self.range < 256 {
            self.range <<= 1;
            self.offset <<= 1;
            self.bits_needed += 1;
            if self.bits_needed >= 0 {
                self.load_byte();
            }
        }
    }

    /// 加载下一个字节到 offset
    fn load_byte(&mut self) {
        if self.pos < self.data.len() {
            self.offset |= self.data[self.pos] as u32;
            self.pos += 1;
        }
        self.bits_needed = -8;
    }
}

/// 初始化 CABAC 上下文模型数组 (I-slice)
pub fn init_contexts_i_slice(qp: i32) -> Vec<CabacCtx> {
    let mut ctxs = vec![CabacCtx { state: 0, mps: 0 }; 1024];
    for (i, &(m, n)) in CABAC_INIT_I.iter().enumerate() {
        if i < ctxs.len() {
            ctxs[i] = init_single_ctx(m, n, qp);
        }
    }
    ctxs
}

/// 初始化 CABAC 上下文模型数组 (P-slice, cabac_init_idc=0)
pub fn init_contexts_p_slice(qp: i32) -> Vec<CabacCtx> {
    let mut ctxs = vec![CabacCtx { state: 0, mps: 0 }; 1024];
    for (i, &(m, n)) in CABAC_INIT_PB0.iter().enumerate() {
        if i < ctxs.len() {
            ctxs[i] = init_single_ctx(m, n, qp);
        }
    }
    ctxs
}

/// 从 (m, n) 和 QP 计算单个上下文的初始状态
fn init_single_ctx(m: i8, n: i8, qp: i32) -> CabacCtx {
    let pre = (((m as i32) * qp.clamp(0, 51)) >> 4) + n as i32;
    let pre = pre.clamp(1, 126);
    if pre <= 63 {
        CabacCtx {
            state: (63 - pre) as u8,
            mps: 0,
        }
    } else {
        CabacCtx {
            state: (pre - 64) as u8,
            mps: 1,
        }
    }
}

// ============================================================
// CABAC 算术解码表 (H.264 规范 Table 9-48, 9-49, 9-50)
// ============================================================

/// rangeTabLPS[pStateIdx][qCodIRangeIdx] (Table 9-48)
#[rustfmt::skip]
const RANGE_TAB_LPS: [[u8; 4]; 64] = [
    [128,176,208,240],[128,167,197,227],[128,158,187,216],[123,150,178,205],
    [116,142,169,195],[111,135,160,185],[105,128,152,175],[100,122,144,166],
    [ 95,116,137,158],[ 90,110,130,150],[ 85,104,123,142],[ 81, 99,117,135],
    [ 77, 94,111,128],[ 73, 89,105,122],[ 69, 85,100,116],[ 66, 80, 95,110],
    [ 62, 76, 90,104],[ 59, 72, 86, 99],[ 56, 69, 81, 94],[ 53, 65, 77, 89],
    [ 51, 62, 73, 85],[ 48, 59, 69, 80],[ 46, 56, 66, 76],[ 43, 53, 63, 72],
    [ 41, 50, 59, 69],[ 39, 48, 56, 65],[ 37, 45, 54, 62],[ 35, 43, 51, 59],
    [ 33, 41, 48, 56],[ 32, 39, 46, 53],[ 30, 37, 43, 50],[ 29, 35, 41, 48],
    [ 27, 33, 39, 45],[ 26, 31, 37, 43],[ 24, 30, 35, 41],[ 23, 28, 33, 39],
    [ 22, 27, 32, 37],[ 21, 26, 30, 35],[ 20, 24, 29, 33],[ 19, 23, 27, 31],
    [ 18, 22, 26, 30],[ 17, 21, 25, 28],[ 16, 20, 23, 27],[ 15, 19, 22, 25],
    [ 14, 18, 21, 24],[ 14, 17, 20, 23],[ 13, 16, 19, 22],[ 12, 15, 18, 21],
    [ 12, 14, 17, 20],[ 11, 14, 16, 19],[ 11, 13, 15, 18],[ 10, 12, 15, 17],
    [ 10, 12, 14, 16],[  9, 11, 13, 15],[  9, 11, 12, 14],[  8, 10, 12, 14],
    [  8,  9, 11, 13],[  7,  9, 11, 12],[  7,  9, 10, 12],[  7,  8, 10, 11],
    [  6,  8,  9, 11],[  6,  7,  9, 10],[  6,  7,  8, 10],[  2,  2,  2,  2],
];

/// transIdxLPS[pStateIdx] (Table 9-49): LPS 状态转移
#[rustfmt::skip]
const TRANS_IDX_LPS: [u8; 64] = [
     0, 0, 1, 2, 2, 4, 4, 5, 6, 7, 8, 9, 9,11,11,12,
    13,13,15,15,16,16,18,18,19,19,21,21,22,22,23,24,
    24,25,26,26,27,27,28,29,29,30,30,30,31,32,32,33,
    33,33,34,34,35,35,35,36,36,36,37,37,37,38,38,63,
];

/// transIdxMPS[pStateIdx] (Table 9-50): MPS 状态转移
#[rustfmt::skip]
const TRANS_IDX_MPS: [u8; 64] = [
     1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15,16,
    17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,
    33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,
    49,50,51,52,53,54,55,56,57,58,59,60,61,62,62,63,
];

// ============================================================
// 上下文初始化表 (m, n) — 来自 H.264 规范 Table 9-12 ~ 9-23
// ============================================================

/// I-slice 上下文初始化表 (ctxIdx 0..276)
#[rustfmt::skip]
const CABAC_INIT_I: [(i8, i8); 277] = [
    // 0-10
    (20,-15),(2,54),(3,74),(20,-15),(2,54),(3,74),(-28,127),(-23,104),(-6,53),(-1,54),(7,51),
    // 11-23 (unused for I)
    (0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),
    // 24-39
    (0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),
    // 40-59
    (0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),(0,0),
    (0,0),(0,0),(0,0),(0,0),(0,0),(0,0),
    // 60-69
    (0,41),(0,63),(0,63),(0,63),(-9,83),(4,86),(0,97),(-7,72),(13,41),(3,62),
    // 70-87
    (0,11),(1,55),(0,69),(-17,127),(-13,102),(0,82),(-7,74),(-21,107),
    (-27,127),(-31,127),(-24,127),(-18,95),(-27,127),(-21,114),(-30,127),(-17,123),(-12,115),(-16,122),
    // 88-104
    (-11,115),(-12,63),(-2,68),(-15,84),(-13,104),(-3,70),(-8,93),(-10,90),
    (-30,127),(-1,74),(-6,97),(-7,91),(-20,127),(-4,56),(-5,82),(-7,76),(-22,125),
    // 105-135
    (-7,93),(-11,87),(-3,77),(-5,71),(-4,63),(-4,68),(-12,84),(-7,62),
    (-7,65),(8,61),(5,56),(-2,66),(1,64),(0,61),(-2,78),(1,50),
    (7,52),(10,35),(0,44),(11,38),(1,45),(0,46),(5,44),(31,17),
    (1,51),(7,50),(28,19),(16,33),(14,62),(-13,108),(-15,100),
    // 136-165
    (-13,101),(-13,91),(-12,94),(-10,88),(-16,84),(-10,86),(-7,83),(-13,87),
    (-19,94),(1,70),(0,72),(-5,74),(18,59),(-8,102),(-15,100),(0,95),
    (-4,75),(2,72),(-11,75),(-3,71),(15,46),(-13,69),(0,62),(0,65),
    (21,37),(-15,72),(9,57),(16,54),(0,62),(12,72),
    // 166-196
    (24,0),(15,9),(8,25),(13,18),(15,9),(13,19),(10,37),(12,18),
    (6,29),(20,33),(15,30),(4,45),(1,58),(0,62),(7,61),(12,38),
    (11,45),(15,39),(11,42),(13,44),(16,45),(12,41),(10,49),(30,34),
    (18,42),(10,55),(17,51),(17,46),(0,89),(26,-19),(22,-17),
    // 197-226
    (26,-17),(30,-25),(28,-20),(33,-23),(37,-27),(33,-23),(40,-28),(38,-17),
    (33,-11),(40,-15),(41,-6),(38,1),(41,17),(30,-6),(27,3),(26,22),
    (37,-16),(35,-4),(38,-8),(38,-3),(37,3),(38,5),(42,0),(35,16),
    (39,22),(14,48),(27,37),(21,60),(12,68),(2,97),
    // 227-251
    (-3,71),(-6,42),(-5,50),(-3,54),(-2,62),(0,58),(1,63),(-2,72),
    (-1,74),(-9,91),(-5,67),(-5,27),(-3,39),(-2,44),(0,46),(-16,64),
    (-8,68),(-10,78),(-6,77),(-10,86),(-12,92),(-15,55),(-10,60),(-6,62),(-4,65),
    // 252-275
    (-12,73),(-8,76),(-7,80),(-9,88),(-17,110),(-11,97),(-20,84),(-11,79),
    (-6,73),(-4,74),(-13,86),(-13,96),(-11,97),(-19,117),(-8,78),(-5,33),
    (-4,48),(-2,53),(-3,62),(-13,71),(-10,79),(-12,86),(-13,90),(-14,97),
    // 276
    (0,0),
];

/// P-slice (cabac_init_idc=0) 上下文初始化表 (ctxIdx 0..276)
#[rustfmt::skip]
const CABAC_INIT_PB0: [(i8, i8); 277] = [
    // 0-10
    (20,-15),(2,54),(3,74),(20,-15),(2,54),(3,74),(-28,127),(-23,104),(-6,53),(-1,54),(7,51),
    // 11-23
    (23,33),(23,2),(21,0),(1,9),(0,49),(-37,118),(5,57),(-13,78),(-11,65),(1,62),(12,49),(-4,73),(17,50),
    // 24-39
    (18,64),(9,43),(29,0),(26,67),(16,90),(9,104),(-46,127),(-20,104),
    (1,67),(-13,78),(-11,65),(1,62),(-6,86),(-17,95),(-6,61),(9,45),
    // 40-53
    (-3,69),(-6,81),(-11,96),(6,55),(7,67),(-5,86),(2,88),(0,58),
    (-3,76),(-10,94),(5,54),(4,69),(-3,81),(0,88),
    // 54-59
    (-7,67),(-5,74),(-4,74),(-5,80),(-7,72),(1,58),
    // 60-69
    (0,41),(0,63),(0,63),(0,63),(-9,83),(4,86),(0,97),(-7,72),(13,41),(3,62),
    // 70-87 (P-slice has 88-70+1=18 + extra entries)
    (0,45),(-4,78),(-3,96),(-27,126),(-28,98),(-25,101),(-23,67),(-28,82),
    (-20,94),(-16,83),(-22,110),(-21,91),(-18,102),(-13,93),(-29,127),(-7,92),(-5,89),(-7,96),
    // 88-104
    (-13,108),(-3,46),(-1,65),(-1,57),(-9,93),(-3,74),(-9,92),(-8,87),
    (-23,126),(5,54),(6,60),(6,59),(6,69),(-1,48),(0,68),(-4,69),(-8,88),
    // 105-135
    (-2,85),(-6,78),(-1,75),(-7,77),(2,54),(5,50),(-3,68),(1,50),
    (6,42),(-4,81),(1,63),(-4,70),(0,67),(2,57),(-2,76),(11,35),
    (4,64),(1,61),(11,35),(18,25),(12,24),(13,29),(13,36),(-10,93),
    (-7,73),(-2,73),(13,46),(9,49),(-7,100),(9,53),(2,53),
    // 136-165
    (5,53),(-2,61),(0,56),(0,56),(-13,63),(-5,60),(-1,62),(4,57),
    (-6,69),(4,57),(14,39),(4,51),(13,68),(3,64),(1,61),(9,63),
    (7,50),(16,39),(5,44),(4,52),(11,48),(-5,60),(-1,59),(0,59),
    (22,33),(5,44),(14,43),(-1,78),(0,60),(9,69),
    // 166-196
    (11,28),(2,40),(3,44),(0,49),(0,46),(2,44),(2,51),(0,47),
    (4,39),(2,62),(6,46),(0,54),(3,54),(2,58),(4,63),(6,51),
    (6,57),(7,53),(6,52),(6,55),(11,45),(14,36),(8,53),(-1,82),
    (7,55),(-3,78),(15,46),(22,31),(-1,84),(25,7),(30,-7),
    // 197-226
    (28,3),(28,4),(32,0),(34,-1),(30,6),(30,6),(32,9),(31,19),
    (26,27),(26,30),(37,20),(28,34),(17,70),(1,67),(5,59),(9,67),
    (16,30),(18,32),(18,35),(22,29),(24,31),(23,38),(18,43),(20,41),
    (11,63),(9,59),(9,64),(-1,94),(-2,89),(-9,108),
    // 227-251
    (-6,76),(-2,44),(0,45),(0,52),(-3,64),(-2,59),(-4,70),(-4,75),
    (-8,82),(-17,102),(-9,77),(3,24),(0,42),(0,48),(0,55),(-6,59),
    (-7,71),(-12,83),(-11,87),(-30,119),(1,58),(-3,29),(-1,36),(1,38),(2,43),
    // 252-275
    (-6,55),(0,58),(0,64),(-3,74),(-10,90),(0,70),(-4,29),(5,31),
    (7,42),(1,59),(-2,58),(-3,72),(-3,81),(-11,97),(0,58),(8,5),
    (10,14),(14,18),(13,27),(2,40),(0,58),(-3,70),(-6,79),(-8,85),
    // 276
    (0,0),
];
