# tao-codec 视频解码器整体开发计划

## 1. FFmpeg 视频解码器与特性分析

视频解码器拥有比音频更庞大的数据吞吐量与极其复杂的空间、时间压缩算法。为了在纯 Rust 框架 Tao 中实现对 FFmpeg 能力的复刻，需对视频解码器阵列及核心视频特性进行分类与剖析。

### 1.1 视频解码器分类概览

1. **图像与帧内格式 (Intra-only / Images)**
    - **MJPEG (Motion JPEG) / JPEG**: 基于 8x8 DCT 变换、量化、Huffman 编码。常见于早期数码相机或简单的 IPCam。
    - **PNG / BMP / GIF**: 基础静态图像与简单动画，常作为动图或字幕覆盖的基础。
    - **ProRes / DNxHD**: 专业视频编辑中间件(Intermediate Codecs)，主要采用纯帧内高比特率压缩获取极高画质。

2. **早期与经典编解码器 (Early & Classic Video Codecs)**
    - **MPEG-1 Video**: 首个广泛使用的视频标准（如 VCD），引入 I、P、B 帧概念。
    - **MPEG-2 Video**: DVD 与早期数字电视广播标准，支持隔行扫描(Interlacing)。
    - **MPEG-4 Part 2 (ASP)**: 鼎鼎大名的 DivX / Xvid 格式，广泛应用于早期网络视频分享。

3. **现代主流标准 (Modern Mainstream Codecs)**
    - **H.264 / AVC (MPEG-4 Part 10)**: 当前世界应用最广泛的视频格式。核心技术：多参考帧、可变宏块分割、帧内预测、CABAC 算术编码、环路滤波(Deblocking Filter)。
    - **H.265 / HEVC**: 专为 4K/8K 时代设计，是 H.264 的继任者。核心技术：编码树单元(CTU)高达 64x64，更复杂的预测角度，支持 10-bit 及 HDR。

4. **开放网络与下一代标准 (Open Web & Next-Gen Codecs)**
    - **VP8**: Google 推出的开源格式，WebRTC 的早期标配阶段格式。
    - **VP9**: YouTube 广泛使用的 4K 高清主战格式，对标 HEVC。
    - **AV1**: 开放媒体联盟(AOMedia)的全新免授权税标准，具备极高压缩比。核心技术：更复杂的方向预测、全局运动补偿、CDEF 约束定向增强滤波、超分辨率支持。

### 1.2 FFmpeg 视频解码核心特性抽象 (Features)

视频解码器需要对齐一系列基础的图形学与状态机抽象特性：

- **Pixel Formats (像素格式与色彩空间)**:
    - 支持 `YUV420p, YUV422p, YUV444p, RGB24, RGBA` 等，并需支持 8-bit / 10-bit / 12-bit 深色域(Bit Depths)切换。
    - 需要处理 `Color Space` (BT.709, BT.2020), `Transfer Characteristics` (PQ/HLG 等 HDR 元数据), 及 `Color Range` (TV 16-235 / PC 0-255)。
- **GOP 结构与帧类型**:
    - 精确处理 I帧(Intra), P帧(Predictive), B帧(Bi-predictive)。
    - 理解展示时间(PTS)与解码时间(DTS)的回环错位，接管参考帧缓冲区(DPB, Decoded Picture Buffer)。
- **隔行与逐行扫描 (Interlacing / Progressive)**:
    - 处理包含顶场(Top field)与底场(Bottom field)的过时/遗留电视信号。
- **DSP 与数学工具**:
    - 高度复用的各类 DCT/IDCT 变换库 (8x8, 16x16, 32x32)。
    - 亚像素(Sub-pixel)精度的运动补偿(Motion Compensation)插值滤波器。
    - CABAC/CAVLC 及 Golomb/Exp-Golomb 可变长解码器抽象。

## 2. 整体开发计划

由于视频解码状态机(尤其是 DPB 参考帧重排)极为复杂，执行时必须采用先图后影、先简后繁的路线：

### 阶段一：稳固基建与图像解析 (基础与铺路)

**目标**：建立视频帧的基础数据结构、色彩空间换算(YUV->RGB)、并能够解析相对简单的纯帧内格式，拉通视频数据流。

- **MJPEG**: 实现 8x8 DCT 逆变换和基础量化表的解析，无状态依赖(即解即用)。
- **PNG / BMP**: 跑通带有透明通道(Alpha) 和调色板映射(Palette) 的静态图像及帧渲染链路，完善 Frame 缓冲内存复用机制。

### 阶段二：宏块时代的视频解码器 (运动补偿启蒙)

**目标**：引入帧间预测、运动矢量、宏块结构以及基础的 I/P/B 帧重排架构与解析逻辑。

- **MPEG-1 / MPEG-2**: 构建基础的半像素运动插值(Half-pixel interpolation)，建立环形帧缓冲管理池，支持隔行扫描的回落处理。
- **MPEG-4 Part 2**: 完善四分之一像素(Quarter-pixel) 运动矢量解析等更细粒度的宏块解码。

### 阶段三：H.264 / AVC 的王者攻坚 (生产力覆盖)

**目标**：彻底实现并覆盖如今互联网最常用、设计极为精密的主流标准，搭建现代解码器通用基石。

- **H.264 / AVC**:
    - 构建高度优化的 CABAC 熵解码器状态引擎。
    - 实现多种尺寸(4x4/8x8/16x16)的帧内预测算法族。
    - 重实现极度复杂的 H.264 参考帧管理(DPB) 与解码序列丢帧/容错恢复能力。
    - 纯手搓实现 Deblocking Filter 以消除块效应。

### 阶段四：跨入下一个时代 (10-bit与超高清架构)

**目标**：重构并扩展解码缓冲(以容纳大位深) ，支持复杂的 CTU 语法及现代开放视频标准。

- **VP8 / VP9**: 验证与 WebM 容器解复用打通能力，支持 VP9 高阶参考帧更新算法与概率树解码解析。
- **H.265 / HEVC**: 扩展宏块切割为非对称的编码树，打通 10-bit 色彩深度的内存表达，支持 HDR 静态/动态元数据的外抛机制。
- **AV1**: 基于最新算力架构支持 AV1 大杂烩般的滤波器网与多种变换组合。

## 3. 具体解码器开发流程规范与计划衔接

为了保障每一个子模块均可落户纯自研的框架并易于进行 AI 驱动协作，当本计划中的任务启动具体研发时，必须遵循如下执行规范：

1. **计划对标与参考模板**
   所有视频解码器的具体开发在真正动手前，**必须首先参考 @[../../rust/tao/plans/tao-codec/audio/vorbis/decoder_dev.md]（无论音视频皆以此为标准格式）来制作该视频解码器的专属开发计划**。
2. **制定专属的子计划**
   对于计划中的每一个格式（如 `MJPEG`, `MPEG2`, `H264`），需在 `plans/tao-codec/` 目录下创建对应的详细执行计划（如 `video/h264/dev.md`）。计划细节必须包含：
    - 测试样板锁定：明确验证使用的 H.264 视音频短片（含 SPS/PPS）。
    - 架构解耦拆解：例如 H.264 需要拆分为 NALU 解析模块、Slice 句法模块、CABAC 执行模块、宏块复原及环路滤波等子目录结构。
    - 定义详尽到每个小环节、可独立测试闭环的 P0 - P5 任务清单。
3. **分阶段与逐帧/逐宏块验证**
   执行纯 Rust 编码时，每一阶段完成后必须跑通严格的代码质量红线 (`cargo fmt, clippy, check, test`) 并做阶段性 Commit。
   视频特有的产出要求：必须实现对应 FFmpeg 输出的 MD5/YUV 原始裸数据逐帧逐图的比对。不仅要比对最终像素结果，在深水区开发时(如 H.264)，需建立中间产物(运动矢量/残差网格)的可视化比对或测试探针，以免陷入画质花屏排错的黑盒迷宫。

---

> **后续计划对齐**：当视频解码器生态基础落地后，应依据本计划模式，以同等粒度逐步补充建立 **[视频编码器整体开发计划](encoder_overall.md)**，进一步完善 Tao 的多媒体编解码能力。
