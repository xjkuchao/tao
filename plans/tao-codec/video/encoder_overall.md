# tao-codec 视频编码器整体开发计划

## 1. FFmpeg 视频编码器与特性分析

视频编码器是视频处理的核心环节，需要对原始视频帧进行高度复杂的空间、时间、频率压缩并生成符合标准的码流。为了在纯 Rust 框架 Tao 中逐步实现对 FFmpeg 编码能力的复刻，需对视频编码器作全面的分类与技术分析。

### 1.1 视频编码器分类概览

1. **图像与帧内编码格式 (Intra-only / Image Encoders)**
    - **MJPEG (Motion JPEG) / JPEG**: 基于 8x8 DCT 变换、量化、Huffman 编码。无帧间依赖，每帧独立编码，适合实时应用与流传输。
    - **PNG / BMP / GIF**: 静态图像与简单动画编码，涉及滤波链(Filter Chain)、调色板优化、LZ77 压缩等。
    - **ProRes / DNxHD**: 专业中间编码器，采用纯帧内高比特率编码以获取极高保真度。

2. **早期与经典编码器 (Early & Classic Video Codecs)**
    - **MPEG-1 Video**: 首批广泛采用的视频标准（如 VCD），引入运动估计与矢量量化。
    - **MPEG-2 Video**: DVD 与数字电视广播标准，支持隔行扫描(Interlacing)编码与多种比特率模式。
    - **MPEG-4 Part 2 (ASP)**: DivX / Xvid 编码格式，支持 B 帧与复杂的宏块分割。

3. **现代主流标准 (Modern Mainstream Codecs)**
    - **H.264 / AVC (MPEG-4 Part 10)**: 当代最广泛应用的视频编码标准。核心技术：多参考帧选择、可变宏块分割、帧内预测角度、CABAC 熵编码、环路滤波(Deblocking Filter)优化。
    - **H.265 / HEVC**: 専為 4K/8K 时代设计，H.264 的继任者。核心技术：编码树单元(CTU)支持最高 64x64、更多预测角度、10-bit 色彩深度、HDR 支持、改进的变换设计。

4. **开放网络与下一代标准 (Open Web & Next-Gen Codecs)**
    - **VP8**: Google 开源格式，WebRTC 早期标准编码器。
    - **VP9**: YouTube 4K 高清主战编码器，对标 HEVC。核心技术：自适应分辨率、复杂的帧间参考管理、概率树编码。
    - **AV1**: 开放媒体联盟(AOMedia)新一代免授权税标准。核心技术：复杂的变换与预测组合、全球运动补偿(GMC)、自适应量化、屏幕内容编码(Screen Content Coding)。

### 1.2 FFmpeg 视频编码核心特性抽象 (Features)

视频编码器在设计与实现时需要考虑以下核心特性与约束：

- **Pixel Formats & Color Spaces (像素格式与色彩空间)**：
    - 支持输入 `YUV420p, YUV422p, YUV444p, RGB24, RGBA` 等多种格式。
    - 处理 8-bit / 10-bit / 12-bit 色深转换，支持 HDR 元数据传送（如 HDR10、Dolby Vision）。
    - 色彩空间转换 (`RGB->YUV`, `BT.709<->BT.2020`)；色彩范围处理(TV vs PC)。

- **GOP 结构与帧类型生成 (GOP Structure & Frame Type)**：
    - 精确生成 I帧、P帧、B帧序列，管理 GOP 长度与帧顺序。
    - 处理 PTS/DTS 计算与帧重排(Frame Reordering)，确保解码期间的参考帧完整性。
    - 支持递进式 B 帧(Hierarchical B Frames)与参考帧差异化分配。

- **比特率控制 (Bitrate Control)**：
    - **CBR (Constant Bitrate)**: 恒定码率，输出大小恒定，适合传输码流(Transport Stream)。
    - **VBR (Variable Bitrate)**: 可变码率，根据复杂度自适应，适合文件存储。
    - **ABR (Average Bitrate)**: 平均码率，在压缩比与质量间平衡，增强兼容性。
    - 第一遍分析(1-pass)与第二遍优化(2-pass) 的码率规划。

- **编码速度与质量权衡 (Preset & Quality)**：
    - `preset`: 预置档位 (ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow)。
    - `crf` 或 `qp`: 质量参数，权衡压缩比与编码时间。

- **运动估计与补偿 (Motion Estimation & Compensation)**：
    - 支持多参考帧选择、分数像素精度(1/4 或 1/8 像素)的运动向量搜索。
    - 实现各类搜索算法(全搜索、快速搜索、菱形搜索等)。

- **变换与量化 (Transform & Quantization)**：
    - DCT / IDCT 变换及其快速实现(Loeffler 等)。
    - 适应性量化(Adaptive Quantization)，以心理视觉敏感度加权。
    - 量化矩阵(Quantization Matrix) 生成与优化。

- **熵编码 (Entropy Encoding)**：
    - Huffman 编码与可变长码字(VLC)表。
    - CABAC(Context-Based Adaptive Arithmetic Coding)，支持上下文建模与概率适应。

- **隔行与逐行扫描编码 (Interlacing)**：
    - 处理顶底场分离、场编码(Field Coding) 与帧编码(Frame Coding)的切换。

- **DSP 与数学工具**：
    - 高效的 DCT/IDCT 变换库(8x8, 16x16, 32x32 多尺寸)。
    - 亚像素精度运动补偿插值滤波器库。
    - CABAC/CAVLC 编码器与码流生成框架。

## 2. 整体开发计划

视频编码器的复杂度极高，涉及运动估计、运动补偿、变换、量化、熵编码等关键环节的协同。开发需采用循序渐进的策略，从简单到复杂，从单帧到多帧：

### 阶段一：稳固基建与图像编码 (基础与铺路)

**目标**：建立编码框架、缓冲管理、基础图像处理管道，并实现纯帧内的简单编码格式，打通视频编码数据流。

- **MJPEG**: 实现 8x8 DCT 变换、量化表的应用、Huffman 编码与 JPEG 帧头生成。无帧间状态依赖，易于验证基础编码流程。
- **PNG / BMP**: 跑通图像滤波链(Filters)、色彩调色板优化、LZ77 压缩等。完善像素采样格式转换与帧缓冲复用。
- **基础编码框架**：建立编码器生命周期、码流生成器(BitWriter)、基础比特率控制框架。

### 阶段二：帧间编码启蒙 (运动估计与补偿)

**目标**：引入运动估计、运动补偿与基础的多帧参考机制，建立 I/P/B 帧的码流生成与管理。

- **MPEG-1 / MPEG-2**: 
    - 实现块匹配(Block Matching)运动估计，支持整像素与半像素精度。
    - 构建参考帧缓冲(Reference Picture Buffer)管理。
    - 支持隔行编码的场编码(Field Coding) 模式。
    - 生成标准的 MPEG 句法与码流。

- **MPEG-4 Part 2**:
    - 扩展四分之一像素(Quarter-pixel)精度运动向量支持。
    - 实现复杂的宏块分割模式(VOP/MB types)。
    - 支持 B 帧编码与参考帧重排。

### 阶段三：H.264 / AVC 的王者攻坚 (生产力覆盖)

**目标**：彻底实现最广泛使用、技术最精密的编码标准，支持多种档位(Profile)与级别(Level)的生产级编码。

- **H.264 / AVC**:
    - 实现高效的运动估计模块：支持多参考帧、可变宏块分割(16x16/8x8/4x4)、分数像素补偿。
    - 构建完整的帧内预测系统：9-35 种预测角度、DC 预测、平面预测等。
    - 实现 CABAC 熵编码器与上下文建模。
    - 引入环路滤波(Deblocking Filter)以消除块效应。
    - 支持码率控制(CRF/QP/ABR/CBR)与自适应量化。
    - 生成完整的 SPS/PPS/NALU 码流。

### 阶段四：跨入下一个时代 (10-bit 与下一代标准)

**目标**：扩展编码框架以支持大位深、超高清分辨率、以及现代开放编码标准的复杂特性。

- **VP8 / VP9**:
    - 实现 VP 系列的预测框架与概率树编码。
    - 支持自适应分辨率与参考帧更新策略。
    - 生成 WebM 容器兼容的码流。

- **H.265 / HEVC**:
    - 扩展宏块切割为编码树单元(CTU)，支持最高 64x64 的智能分割。
    - 实现更复杂的预测系统(35+ 方向预测、INTRA_DC、平面预测等)。
    - 支持 10-bit / 12-bit 色彩深度编码与 HDR 元数据传送。
    - 改进的变换设计(DST 等)与量化矩阵。
    - CABAC 的更复杂上下文建模。

- **AV1**:
    - 支持各类复杂的变换与预测组合。
    - 全局运动补偿(GMC)与参考帧管理。
    - 屏幕内容编码(SCC)特殊优化。
    - 自适应量化与分段编码(Superblock 级)。

## 3. 编码器与解码器的对应关系

为确保编解码的兼容性与互通性，编码器的开发应与已有的解码器相互配合：

| 格式 | 解码器 | 编码器 | 状态 |
|-----|--------|--------|------|
| MJPEG | ✅ | ❌ | 解码完成，编码待开发 |
| PNG / BMP | ✅ | ❌ | 解码完成，编码待开发 |
| MPEG-1 | ❌ | ❌ | 全待开发 |
| MPEG-2 | ❌ | ❌ | 全待开发 |
| MPEG-4 Part 2 | ❌ | ❌ | 全待开发 |
| H.264 / AVC | ✅ | ❌ | 解码完成，编码待开发 |
| H.265 / HEVC | ✅ | ❌ | 解码完成，编码待开发 |
| VP8 | ❌ | ❌ | 全待开发 |
| VP9 | ❌ | ❌ | 全待开发 |
| Theora | ✅ | ❌ | 解码完成，编码待开发 |
| AV1 | ❌ | ❌ | 全待开发 |

**编码器优先级**：优先补齐已有解码器的编码能力(如 MJPEG、H.264、HEVC)，再逐步扩展新格式。

## 4. 具体编码器开发流程规范与计划衔接

为了保障每一个子模块均可落户纯自研的框架并易于进行 AI 驱动协作，当本计划中的任务启动具体研发时，必须遵循如下执行规范：

### 4.1 计划对标与参考模板

所有视频编码器的具体开发在真正动手前，**必须首先参考 @[VorbisAudio编码器开发计划]（取其结构范本）来制作该视频编码器的专属开发计划**。

现有实现可作为参考：

- **RawVideo 编码器** - 最基础的无压缩帧编码框架
- **视频解码器** - 理解码流格式与语法细节

### 4.2 制定专属的子计划

对于计划中的每一个格式（如 `MJPEG`, `H264`, `HEVC` 等），需在 `plans/tao-codec/` 目录下创建对应的详细执行计划（如 `video/h264/encoder_dev.md`）。计划细节必须包含：

- **编码原理与算法分解**：
    - 列举核心编码环节(如 MDCT/DCT、运动估计、量化、熵编码等)。
    - 拆解为模块化的子目录与 Rust 模块结构。

- **参考样本与对标机制**：
    - 指定验证使用的测试视频样本(原始 YUV 和对应的 FFmpeg 编码结果)。
    - 建立逐帧像素级与码流级的比对验证方案(MD5、YUV Diff、PSNR/SSIM)。

- **架构解耦与状态机**：
    - 定义编码器的完整生命周期：初始化 -> Open -> 编码循环 -> Flush -> 关闭。
    - 参考帧缓冲(Reference Picture Buffer)管理与帧类型决定逻辑。
    - 码率管理与自适应量化的反馈循环。

- **比特率控制策略**：
    - CBR/VBR/ABR 的具体实现方案。
    - 目标码率计算与帧级比特预算分配。
    - 第一遍与第二遍(2-pass)分析的配合。

- **详细任务清单**：
    - 定义详尽到每个小环节、可独立测试闭环的 P0 - P5 等级的任务清单。
    - 中间产物的可测试性：例如运动向量、量化参数、变换系数等。

### 4.3 分阶段与逐帧逐宏块验证

根据子计划严格执行编码，每一阶段完成后必须：

1. **代码质量红线**：跑通 `cargo fmt, cargo clippy, cargo check, cargo test`。
2. **编码结果验证**：
    - 基础验证：编码输出能被对应的解码器正确解码。
    - 中间验证：运动向量、量化参数等中间产物与 FFmpeg 对齐。
    - 像素级验证：逐帧 YUV 比对，计算 PSNR/SSIM 等质量指标。
3. **码流级验证**：
    - 比对码流结构(NALU、Slice 头等)。
    - 断点调试能力：可视化 GOP 结构、参考帧关系。
4. **逐次提交**：每完成一个独立的功能模块或任务，立即提交 Git Commit。

## 5. 视频编码器的关键技术难点

### 5.1 运动估计与补偿

视频编码的关键环节，直接影响压缩比与编码时间：

- **搜索算法**：全搜索(Full Search)、快速搜索(Fast Search)、菱形搜索(Diamond Search)等。
- **精度控制**：整像素、半像素、四分之一像素等多精度层级。
- **搜索范围**：自适应搜索范围设定，平衡质量与性能。
- **多参考帧**：参考帧选择与优先级管理。

### 5.2 帧内预测与角度预测

帧内编码的核心，支持多种预测角度与模式：

- **预测角度**：H.264 的 8+ 种模式，H.265/AV1 的 35+ 种角度。
- **预测强度计算**：基于相邻像素的线性内插。
- **平面预测(Planar)**：二阶线性拟合。
- **DC 预测**：均值预测。

### 5.3 比特率控制与自适应量化

确保编码输出满足目标码率同时保持画质：

- **帧级码率分配**：根据内容复杂度与帧类型分配目标比特。
- **宏块级自适应量化**：复杂区域更多保留细节，简单区域加大压缩。
- **缓冲管理**：VBV(Video Buffer Verifier)缓冲模型。
- **前向看(Lookahead)**：分析未来帧的复杂度以优化当前编码决策。

### 5.4 熵编码与码流生成

确保码流的紧凑与标准兼容性：

- **Huffman 编码**：可变长码字表的生成与最优化。
- **CABAC**：上下文建模、概率估计、算术编码的精确实现。
- **比特写入器**：精确的比特级码流生成，确保结构对齐。

## 6. 编码器与解码器框架的对称性设计

为确保编解码的完整互通，编码器框架应与解码器框架保持对称的设计：

| 方面 | 解码器框架 | 编码器框架 |
|-----|-----------|----------|
| Trait | `Decoder` | `Encoder` |
| 初始化 | `open(&mut self, params: &CodecParameters)` | `open(&mut self, params: &CodecParameters)` |
| 处理 | `decode(&mut self, pkt: &Packet, frame: &mut Frame)` | `encode(&mut self, frame: &Frame, pkt: &mut Packet)` |
| 刷新 | `flush(&mut self)` | `flush(&mut self)` |
| 参考帧管理 | 参考帧缓冲(DPB) | 参考帧缓冲(Reference Picture Buffer) |
| 状态管理 | `opened`, `flushing` | `opened`, `flushing` |

---

> **后续计划对齐**：当视频编码器整体生态基础落地后，应与 [音频编码器整体开发计划](../audio/encoder_overall.md) 形成协同，共同支撑 Tao 多媒体框架的完整编解码能力。

