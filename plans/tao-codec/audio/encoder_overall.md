# tao-codec 音频编码器整体开发计划

## 1. FFmpeg 音频编码器与特性分析

FFmpeg 支持海量的音频编码器，为了在纯 Rust 多媒体框架 Tao 中逐步复刻，需对其支持的音频编码器及核心特性进行充分的分类与技术分析。

### 1.1 音频编码器分类概览

1. **无损音频编码 (Lossless Audio Encoding)**
    - **FLAC**: 自由无损音频编码器，广泛应用。核心技术：线性预测算法(LPC)、Rice 编码、自适应块大小、帧头与元数据。
    - **ALAC**: 苹果无损音频编码器，常见于 M4A 容器。核心技术：预测编码、Golomb-Rice 编码、自适应熵编码。
    - **APE (Monkey's Audio)**: 极高压缩比的无损格式。核心技术：自适应预测滤波器、动态比特分配。
    - **WavPack**: 支持无损与有损混合模式编码。核心技术：混合码流架构、量化精度控制。

2. **有损音频编码 (Lossy Audio Encoding) - 音乐及通用音频**
    - **AAC (Advanced Audio Coding)**: 当代最主流有损格式。包含 LC, HE-AAC v1/v2, xHE-AAC 等多种配置。核心技术：MDCT 变换、心理声学量化、SBR 生成、PS 参数化。
    - **MP3 (MPEG-1/2 Audio Layer III)**: 历史最悠久的经典格式，广泛兼容。核心技术：MDCT + 多相滤波器、Huffman 编码、Bit Reservoir 管理、心理声学模型。
    - **Vorbis**: 开源经典格式，常封装于 Ogg/WebM。核心技术：MDCT、自适应窗切换、Floor/Residue 编码、Codebook 生成。
    - **Opus**: 当前最具优势的低延迟开源格式，常用于 WebRTC。核心技术：SILK 语音编码 + CELT 音乐编码双引擎、混合模式管理、极低延迟吐帧。

3. **影院与空间音频编码 (Cinema & Spatial Audio Encoding)**
    - **AC-3 (Dolby Digital) / E-AC-3**: 常见于 DVD/蓝光及流媒体电视。核心技术：多声道编码、动态范围控制(DRC)、计时同步、下混矩阵生成。
    - **DTS / DTS-HD**: 家庭影院高保真音频。核心技术：核心码流与扩展差分码流管理、多声道同步。

4. **语音通信与低带宽格式编码 (Speech / Voice)**
    - **AMR (NB/WB)**: 早期移动通信标准语音编码。核心技术：代数码激励线性预测(ACELP)、自适应多速率。
    - **Speex**: 专为语音设计的早期开源编码器，现多被 Opus 替代。核心技术：CELP 码流、噪声抑制、质量可调。
    - **PCM / ADPCM**: 原始未压缩或简单差分脉冲编码调制，计算复杂度极低。常见于 WAV 封装与通信。
    - **G.711 / G.722**: 常见 VoIP 语音编码，主打单字节非线性量化(A-law/μ-law)。核心技术：对数量化、低计算复杂度。

### 1.2 FFmpeg 音频编码核心特性抽象 (Features)

在开发 `tao-codec` 音频编码系统时，不仅需要完成单一算法，还要对齐 FFmpeg 提供的一系列核心多媒体特性抽象：

- **Sample Formats (采样格式)**: 精确支持输入 `u8, s16, s32, f32, f64` 等多种类型，并兼容交错格式(Interleaved, 例如 `LRLR`)与平面格式(Planar, 例如 `LL RR`)。编码器需灵活处理多种输入格式。
- **Channel Layouts (声道布局)**: 标准化定义单声道(Mono), 立体声(Stereo), 2.1, 5.1, 7.1 等多声道配置。编码器需支持多声道布局自动适配与混音。
- **Bitrate Control (比特率控制)**: 支持 CBR(恒定码率)、VBR(可变码率)、ABR(平均码率)等多种编码模式，平衡质量与文件大小。
- **Quality & Performance**: 提供质量等级(0-100)或目标码率参数，权衡编码时间与输出质量。
- **DSP 与数学工具**: 沉淀高度复用的 MDCT 变换库、FFT 操作库、心理声学模型、量化表与 Huffman 编码器。
- **帧管理与同步**: 支持帧缓冲、帧时长计算、PTS/DTS 精确管理，进行 Flush 处理与尾部填充。

## 2. 整体开发计划

为了满足 Tao 项目纯自研、不依赖外部媒体库的硬性要求，音频编码器的开发将按以下四大阶段推行，与解码器开发相互配合：

### 阶段一：稳固基建与开源生态破冰 (基础与铺路)

**目标**：建立编码框架、缓冲管理机制，并优先实现非专利阻力大且文档完备的开源格式编码。

- **PCM / ADPCM / G.711** 族：实现基础编码框架、采样格式转换、声道布局变换。建立编码器与解码器的框架对称性。
- **FLAC**: 完成 LPC 预测、Rice 编码、块大小自适应、元数据管理。验证无损编码框架完整性。
- **Vorbis**: 跑通 MDCT 编码、Floor/Residue 自研编码全流程、Codebook 生成。验证有损编码复杂状态机。

### 阶段二：大众与高频格式攻坚 (生产力覆盖)

**目标**：攻克最主流、最高应用频率的编码格式，满足 80% 以上的本地录制与流媒体编码场景。

- **AAC (基础篇: AAC-LC)**: 开发 MDCT、心理声学量化、多声道矩阵编码、ADTS 帧生成。覆盖 MP4 等主流容器编码。
- **MP3**: 实现 MDCT、多相滤波器、Bit Reservoir 管理、Huffman 编码、心理声学模型。处理复杂的跨帧缓冲机制。
- **Opus**: 验证 SILK + CELT 混合编码、自适应码率控制、低延迟吐帧能力。

### 阶段三：影院多声道与立体声增强 (进阶特性)

**目标**：支持高质量影视内容的多声道编码与专业音频处理需求。

- **AC-3 / E-AC-3**: 实现多声道编码、DRC 元数据管理、下混矩阵计算、同步帧生成。
- **AAC (进阶篇: HE-AAC v1/v2)**: 实现 SBR 生成与 PS 参数化，处理极高频信号编码。

### 阶段四：长尾与遗留格式补全 (生态对齐)

**目标**：面向老旧媒体与特殊应用场景，逐步逼近 FFmpeg 的全面度。

- 剩余重要无损格式编码：ALAC, APE 等。
- 剩余工业级低宽带语音编码：AMR-NB/WB, WMA, Speex 等。

## 3. 编码器与解码器的对应关系

为确保编解码的完整性与互操作性，编码器的开发应与已实现的解码器紧密对应：

| 格式 | 解码器 | 编码器 | 状态 |
|-----|--------|--------|------|
| PCM | ✅ | ✅ | 完成 |
| FLAC | ✅ | ✅ | 完成 |
| Vorbis | ✅ | ❌ | 解码完成，编码待开发 |
| AAC-LC | ✅ | ✅ | 完成 |
| MP3 | ✅ | ❌ | 解码完成，编码待开发 |
| Opus | ❌ | ❌ | 全待开发 |
| AC-3 / E-AC-3 | ❌ | ❌ | 全待开发 |
| ALAC | ❌ | ❌ | 全待开发 |

编码器开发优先级应与解码器基本对应，**优先补齐已有解码器的编码能力**，再逐步扩展新格式。

## 4. 具体编码器开发流程规范与计划衔接

为了保障每一个子模块均可落户纯自研的框架并易于进行 AI 驱动协作，当本计划中的任务启动具体研发时，必须遵循如下执行规范：

### 4.1 计划对标与参考模板

未来在具体执行某个编码器的详细开发前，**必须首先参考已有的编码器示例来制作具体的编码器开发计划**。推荐参考：

- **FLAC 编码器** (`flac.rs`) 作为无损编码的参考模板
- **AAC-LC 编码器** (`aac.rs`) 作为有损编码的参考模板
- **PCM 编码器** (`pcm.rs`) 作为基础编码框架的参考模板

### 4.2 制定专属的子计划

对于计划中的每一个格式（如 `MP3`, `Vorbis`, `Opus` 等），都需在 `plans/tao-codec/` 目录下创建对应的详细执行计划（如 `encoder_dev.md`）。计划细节应包含：

- **编码原理与算法分解**：将编码算法（如 MDCT、量化、熵编码）拆解为独立的子模块。
- **与参考样本的对应关系**：建立 FFmpeg 编码输出与 Tao 编码输出的样本对标机制。
- **架构设计思路**：定义码流结构、缓冲管理、比特率控制等关键模块的设计方案。
- **编码器状态机**：明确初始化、编码、刷新(Flush)、关闭等全生命周期的状态转移。
- **输入输出规范**：定义支持的采样率、声道数、采样格式、码率等参数范围。
- **详细任务清单**：定义详尽到每个小环节、可独立测试闭环的 P0 - P5 等级的任务清单。

### 4.3 分阶段与逐帧对齐测试

根据子计划严格执行编码，每一阶段完成后必须：

1. 跑通编译要求：`cargo fmt, cargo clippy, cargo check, cargo test`
2. 执行逐帧对标验证：通过 MSE/PSNR 将 Tao 编码后再解码的输出与 FFmpeg 编码后再解码的输出进行严格对齐测试。
3. 逐次提交 Git Commit，保持提交原子性与可追溯性。

## 5. 编码器开发关键技术点

### 5.1 比特率控制 (Bitrate Control)

编码器需支持多种码率控制模式：

- **CBR (Constant Bitrate)**: 恒定码率，输出帧大小相对固定，适合实时流传输。
- **VBR (Variable Bitrate)**: 可变码率，根据内容自适应码率，适合高质量存储。
- **ABR (Average Bitrate)**: 平均码率，在文件大小与质量之间取平衡。

编码器应实现自适应量化、帧大小调整等机制，确保码率目标达成。

### 5.2 心理声学模型

有损编码器应实现基础心理声学模型，理解：

- 掩蔽效应(Masking Effect)：强信号对弱信号的掩蔽
- 临界带宽(Critical Band)：人耳频率分辨能力的限制
- 动态范围知觉(Dynamic Range Perception)

### 5.3 缓冲与帧管理

编码器需精确管理：

- 输入帧缓冲：汇聚零散的样本，拼接成完整的编码块
- 输出帧队列：缓存编码后的数据包，支持逐个取出
- Flush 处理：处理尾部非整数倍帧的填充与最终数据包生成
- PTS/DTS 计算：确保编码后数据包的时间戳准确

### 5.4 采样格式与声道转换

编码器需支持灵活的输入处理：

- 格式转换：`f32 -> s16` 或其他需要的转换
- 交错/平面格式互转：`LRLR -> LL RR` 等
- 声道混音/提取：立体声 -> 单声道 等简单混音操作

## 6. 编码器与解码器框架的对称性设计

为了最大化代码复用与一致性，编码器框架应与解码器框架保持对称的设计：

| 方面 | 解码器框架 | 编码器框架 |
|-----|-----------|----------|
| Trait | `Decoder` | `Encoder` |
| 初始化 | `open(&mut self, params: &CodecParameters)` | `open(&mut self, params: &CodecParameters)` |
| 处理 | `decode(&mut self, pkt: &Packet, frame: &mut Frame)` | `encode(&mut self, frame: &Frame, pkt: &mut Packet)` |
| 刷新 | `flush(&mut self)` | `flush(&mut self)` |
| 状态 | `opened`, `flushing` | `opened`, `flushing` |

编码器应复用相同的 `Frame`、`Packet`、`CodecParameters` 等数据结构。

---

> **后续计划对齐**：当音频编码器整体生态基础落地后，应依据本计划模式制定 **视频解码器整体开发计划** 和 **视频编码器整体开发计划**，进一步完善 Tao 的多媒体编解码生态。

