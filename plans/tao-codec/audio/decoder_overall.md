# tao-codec 音频解码器整体开发计划

## 1. FFmpeg 音频解码器与特性分析

FFmpeg 支持海量的音频解码器，为了在纯 Rust 多媒体框架 Tao 中逐步复刻，需对其支持的音频解码器及核心特性进行充分的分类与技术分析。

### 1.1 音频解码器分类概览

1. **无损音频 (Lossless Audio)**
    - **FLAC**: 自由无损音频编解码器，广泛应用。核心技术：线性预测算法(LPC)、Rice 编码、高压缩比无损。
    - **ALAC**: 苹果无损音频编解码器，常见于 M4A 容器。核心技术：预测编码及 Golomb-Rice 编码。
    - **APE (Monkey's Audio)**: 极高压缩比的无损格式。
    - **WavPack**: 支持无损与有损混合模式技术。

2. **有损音频 (Lossy Audio) - 音乐及通用音频**
    - **AAC (Advanced Audio Coding)**: 当代最主流有损格式。包含 LC, HE-AAC v1/v2, xHE-AAC 等多种配置。核心技术：MDCT变换、SBR(频段重现)、PS(参数立体声)。
    - **MP3 (MPEG-1/2 Audio Layer III)**: 历史最悠久的经典格式。核心技术：MDCT+多相滤波器(Filterbank)、Huffman 编码、Bit reservoir 状态保留。
    - **Vorbis**: 开源经典格式，常封装于 Ogg/WebM。核心技术：MDCT、Codebook(Huffman)、Floor/Residue 机制。_(注: 目前已作为首个示例启动)_。
    - **Opus**: 当前最具优势的低延迟开源格式，常用于 WebRTC。核心技术：结合 SILK(语音) 和 CELT(音乐) 双引擎混合编码。

3. **影院与空间音频 (Cinema & Spatial Audio)**
    - **AC-3 (Dolby Digital) / E-AC-3**: 常见于 DVD/蓝光及流媒体电视。核心技术：多声道支持、动态范围控制(DRC)、内部下混(Downmixing)。
    - **DTS / DTS-HD**: 家庭影院高保真音频。核心技术：核心码流与扩展差分码流架构。

4. **语音通信与低带宽格式 (Speech / Voice)**
    - **AMR (NB/WB)**: 早期移动通信标准语音格式。核心技术：代数码激励线性预测(ACELP)。
    - **Speex**: 专为语音设计的早期开源格式，现多被 Opus 替代。
    - **PCM / ADPCM**: 原始未压缩或简单差分脉冲编码调制，计算复杂度极低。常见于 WAV 封装。
    - **G.711 / G.722**: 常见 VoIP 语音格式，主打单字节非线性量化(A-law/μ-law)。

### 1.2 FFmpeg 音频解码核心特性抽象 (Features)

在开发 `tao-codec` 音频系统时，不仅需要完成单一算法，还要对齐 FFmpeg 提供的一系列核心多媒体特性抽象：

- **Sample Formats (采样格式)**: 精确支持 `u8, s16, s32, f32, f64` 等类型，并兼容交错格式(Interleaved, 例如 `LRLR`)与平面格式(Planar, 例如 `LL RR`)。
- **Channel Layouts (声道布局)**: 标准化定义单声道(Mono), 立体声(Stereo), 2.1, 5.1, 7.1 等多声道配置。
- **DSP 与数学工具**: 沉淀高度复用的 MDCT/IMDCT 变换库、FFT 操作库、以及通用 Huffman 前缀码表构建与查找器。
- **时间与音画同步**: 支持基于时间基(`time_base`)的严格帧时长 (`duration`) 计算与基于采样的 PTS 推进演算机制，为上层播放器音视频同步打下基础。

## 2. 整体开发计划

为了满足 Tao 项目纯自研、不依赖外部媒体库的硬性要求，音频解码器的开发将按以下四大阶段推行：

### 阶段一：稳固基建与开源生态破冰 (基础与铺路)

**目标**：建立通用基础计算库（IMDCT、位图读取、窗函数），并优先实现非专利阻力大且文档完备的开源格式。

- **PCM / ADPCM / G.711** 族：实现基础时间轴对账及格式抽象定义，用于彻底打通框架内 `demux -> decode -> play` 数据流。
- **Vorbis**: 跑通极度复杂的 MDCT 及 Floor/Residue 自研解码全流程（验证复杂状态机能力）。
- **FLAC**: 打磨无损编解码框架及位流读取器(BitReader)，建立无损保真度逐帧验证基础框架。

### 阶段二：大众与高频格式攻坚 (生产力覆盖)

**目标**：攻克最主流、技术复杂度最高的基础格式，满足80%以上的本地播放与在线音频流媒体场景。

- **AAC (基础篇: AAC-LC)**: 开发覆盖绝大部分 MP4 等容器的广泛格式，涉及心理声学窗切换与多声道重建矩阵。
- **MP3**: 结合复杂的位流缓存(Bit reservoir)及早期的多相滤波器，验证跨包缓存解析机制。
- **Opus**: 以此验证 `tao-codec` 对混合模型（SILK + CELT组合）以及低延迟高频率吐帧能力的支持。

### 阶段三：影院多声道与立体声增强 (进阶特性)

**目标**：支持高质量影视作品中的复杂声道结构与特定附加元数据。

- **AC-3 / E-AC-3**: 解决基于元数据(Metadata)指导的硬件输出兼容及矩阵下混过滤(5.1 -> Stereo)。
- **AAC (进阶篇: HE-AAC v1/v2)**: 实现 SBR 和 PS ，重点突破频域外推及极高频信号包络线重建。

### 阶段四：长尾与遗留格式补全 (生态对齐)

**目标**：面向老旧媒体及特殊应用格式，逐步逼近 FFmpeg 的全面度。

- 剩余重要无损格式：ALAC, APE 等。
- 剩余工业级低宽带语音格式：AMR-NB/WB, WMA, Speex 等。

## 3. 具体解码器开发流程规范与计划衔接

为了保障每一个子模块均可落户纯自研的框架并易于进行 AI 驱动协作，当本计划中的任务启动具体研发时，必须遵循如下执行规范：

1. **计划对标与参考模板**
   未来在具体执行某个解码器的详细开发前，**必须首先参考 @[../../rust/tao/plans/tao-codec/audio/vorbis/decoder_dev.md] 作为示例来制作具体的解码器开发计划**。
2. **制定专属的子计划**
   对于计划中的每一个格式（如 `AAC`, `FLAC`, `MP3` 等），都需在 `plans/tao-codec/` 目录下创建对应的详细执行计划（如 `dev.md`）。计划细节应包含：
    - 与待复刻的参考样本目标建立对应关系（需包含使用样板或 FFmpeg 预制数据）。
    - 将该解码算法拆解为合理的子目录与多个 Rust 模块结构的架构设计思路。
    - 定义详尽到每个小环节、可独立测试闭环的 P0 - P5 等级的任务清单。
3. **分阶段与逐帧对齐测试**
   根据子计划严格执行编码，每一阶段完成后必须跑通编译要求 (`cargo fmt, clippy, check, test`) 并逐次 Commit。
   所有最终解码器功能产出必须包括一套通过 MSE/PSNR 将样板和 FFmpeg 输出结果做严格“逐帧对标”的自动化测试验证流程。

---

> 当音频解码器生态基础落地后，后续还将依据本计划模式，以同等粒度逐步补充建立 **音频编码器整体开发计划**，以及 **视频解/编码器整体开发计划**。
