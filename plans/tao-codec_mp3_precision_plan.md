# tao-codec MP3 解码精度提升计划

## 1. 背景与目标
- 当前 `tests/mp3_module_compare.rs` 对比 FFmpeg 精度约 66.22%, 距离 100% 目标差距较大。
- 需要定位自研 MP3 解码器与 FFmpeg/开源解码器的差异, 并逐步收敛到 100%。
- 规则优先级: 正确性 > 向后兼容 > 性能 > 开发效率。

## 2. 关键风险与初步判断
- 差异可能来自: bit reservoir 管理, scalefactor 解析, 立体声处理(IS/MS), 重排序/抗混叠, IMDCT 窗函数/缩放, 合成滤波器。
- 需要先判定是否存在“整体增益偏差”或“样本对齐偏移”, 以避免在错误基线上调参。

## 3. 分步任务与预期产出

### P0 基线复现与对齐诊断
- [x] 固化 `data/1.mp3` 对比输出, 记录 PSNR/max_err。
- [x] 增加对齐诊断: 统计最优全局增益/偏移量(采样位移), 判断是否存在整体比例或延迟问题。
- 产出: 基线日志 + 对齐诊断结论。

### P1 引入参考对照(仅测试)
- [x] 选择一个开源 MP3 解码器作为“参考 PCM”补充对照(已改为 symphonia), 仅限 tests/dev 依赖。
- [x] 在测试中输出 Tao/参考/FFmpeg 三方对比, 验证是否为“FFmpeg 特殊差异”或“通用算法差异”。
- 产出: 三方对比报告, 明确参考基准。

### P2 分阶段误差定位
- [x] 在解码流程加入可选快照(每帧/每 granule), 输出关键中间数据: is/xr/立体声后/重排序后/抗混叠后/IMDCT后/合成后。
- [x] 与参考解码器做“阶段级误差对比”, 锁定首个出现明显误差的阶段。
- 产出: 阶段误差报告, 明确问题模块。

### P3 模块修正与回归
- [x] 针对首个异常阶段修正实现(例如: scalefactor 索引、IS/MS 规则、重排序映射、IMDCT 窗函数/缩放、滤波器系数)。
- [x] 每次修正后回归 `mp3_module_compare` 与三方对比。
- 产出: 若干次小步修复提交, 精度持续提升。

### P4 目标达成与验收
- [x] `data/1.mp3` 达到接近或等同 FFmpeg 的 100% 精度。
- [ ] 拓展到 2-3 个样本验证稳定性(仍保持快速执行)。
  备注: 当前按约束仅保留 `data/1.mp3` 快速对比, 多样本验证待后续恢复。
- 产出: 验收报告与最终基线记录。

## 4. 依赖与前置条件
- 本地可用 `ffmpeg` / `ffprobe`。
- 若引入参考解码器, 仅作为 dev/test 依赖, 不进入核心功能路径。

## 5. 验收标准
- `data/1.mp3` 对比 FFmpeg 精度达到 100% 或 PSNR >= 80dB 且 max_err 接近 0。
- 同样的流程对 2-3 个样本稳定通过。

## 6. 进度标记
- [x] P0
- [x] P1
- [x] P2
- [x] P3
- [x] P4
